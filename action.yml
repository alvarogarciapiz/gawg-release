name: 'GAWG Release action'
description: 'This action generates a tag and release for the project inside GitHub.'
author: Álvaro García Pizarro
branding:
  icon: 'git-commit'
  color: 'gray-dark'

inputs:
  config-json:
    type: string
    description: 'JSON string containing workflow config parameters.'
    required: true
  github-token:
    type: string
    description: 'GitHub token for authentication.'
    required: true

runs:
  using: "composite"
  steps:
    - name: 
      if: ${{ fromJson(inputs.config-json).RELEASE == 'disabled' }}
      shell: bash
      run: |
        echo "⚠️ Release is disabled. To enable it, set the RELEASE parameter to 'enabled' in the workflow configuration file."
        echo "⚠️ Release is disabled. To enable it, set the RELEASE parameter to 'enabled' in the workflow configuration file." >> $GITHUB_STEP_SUMMARY
        echo ""

    - name: Set up Git
      shell: bash
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Generate TAG
      if: ${{ fromJson(inputs.config-json).RELEASE == 'enabled' && fromJson(inputs.config-json).TESTING == 'enabled' }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      shell: bash
      run: |
        PROJECT_VERSION=$(echo '${{ fromJson(inputs.config-json).PROJECT_VERSION }}')
        TAG_NAME="v${PROJECT_VERSION}"
        git tag $TAG_NAME
        git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} $TAG_NAME
    
    - name: Generate Release
      if: ${{ fromJson(inputs.config-json).RELEASE == 'enabled' && fromJson(inputs.config-json).TESTING == 'enabled' }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      shell: bash
      run: |
        PROJECT_VERSION=$(echo '${{ fromJson(inputs.config-json).PROJECT_VERSION }}')
        TAG_NAME="v${PROJECT_VERSION}"
        echo "Generating release"
        echo "Config JSON: ${{ inputs.config-json }}"
        gh release create $TAG_NAME --title "Release $TAG_NAME" --notes "Release generated from workflow" --repo ${{ github.repository }}
        echo "Release generated"